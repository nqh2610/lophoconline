# H·ªá Th·ªëng Escrow Payment - An To√†n & B·∫£o M·∫≠t

## üéØ T·ªïng Quan

H·ªá th·ªëng gi·ªØ ti·ªÅn an to√†n (escrow) cho n·ªÅn t·∫£ng h·ªçc tr·ª±c tuy·∫øn, ƒë·∫£m b·∫£o:
- ‚úÖ **H·ªçc sinh**: Ti·ªÅn ƒë∆∞·ª£c b·∫£o v·ªá, ch·ªâ tr·∫£ khi h·ªçc xong
- ‚úÖ **Gia s∆∞**: Nh·∫≠n ƒë√∫ng ti·ªÅn sau m·ªói bu·ªïi h·ªçc
- ‚úÖ **N·ªÅn t·∫£ng**: Thu ph√≠ hoa h·ªìng t·ª± ƒë·ªông
- ‚úÖ **B·∫£o m·∫≠t**: HMAC-SHA256 verification, audit logs ƒë·∫ßy ƒë·ªß
- ‚úÖ **Shared hosting**: An to√†n ngay c·∫£ tr√™n m√¥i tr∆∞·ªùng chia s·∫ª

## üìä Lu·ªìng Nghi·ªáp V·ª• Chi Ti·∫øt

### 1. ƒêƒÉng K√Ω L·ªõp H·ªçc
```
POST /api/enrollments/create
{
  "tutorId": 1,
  "subjectId": 2,
  "gradeLevelId": 10,
  "totalSessions": 10,      // S·ªë bu·ªïi h·ªçc
  "pricePerSession": 200000, // 200k/bu·ªïi
  "startDate": "2025-11-01",
  "schedule": "[{\"day\": 2, \"time\": \"18:00-19:30\"}]"
}
```

**K·∫øt qu·∫£**:
- T·∫°o `class_enrollments` (status = 'pending')
- `totalAmount` = 10 * 200,000 = 2,000,000 VNƒê
- Notification cho gia s∆∞

### 2. Thanh To√°n

```
POST /api/payment/create
{
  "enrollmentId": 123,
  "gateway": "vnpay" // ho·∫∑c "momo"
}
```

**Flow**:
1. T·∫°o `payments` record (status = 'pending')
2. Generate unique `transactionCode`
3. T·∫°o payment URL v·ªõi HMAC signature
4. Redirect h·ªçc sinh sang VNPay/Momo

**VNPay URL Example**:
```
https://sandbox.vnpayment.vn/paymentv2/vpcpay.html?
  vnp_Amount=200000000&
  vnp_Command=pay&
  vnp_CreateDate=20251019140530&
  vnp_IpAddr=192.168.1.1&
  vnp_OrderInfo=Thanh+toan+lop+hoc+...&
  vnp_TxnRef=ENR123_1729342530&
  vnp_SecureHash=abc123...
```

### 3. Callback T·ª´ Payment Gateway

```
GET /api/payment/vnpay/callback?
  vnp_TxnRef=ENR123_1729342530&
  vnp_Amount=200000000&
  vnp_ResponseCode=00&
  vnp_SecureHash=...
```

**QUAN TR·ªåNG - B·∫£o M·∫≠t**:
1. ‚úÖ **Verify HMAC signature** (MUST DO)
   ```typescript
   const isValid = verifyVNPayCallback(callbackParams);
   if (!isValid) {
     // C·∫¢NH B√ÅO: C√≥ th·ªÉ b·ªã t·∫•n c√¥ng
     logSecurityAlert();
     return redirect('/payment/failed?error=invalid_signature');
   }
   ```

2. ‚úÖ **Check response code**
   - '00' = Success
   - '24' = User cancelled
   - '51' = Insufficient balance
   - etc.

3. ‚úÖ **Atomic transaction** (tr√°nh duplicate)
   ```typescript
   await db.transaction(async (tx) => {
     // Update payment
     // Create escrow
     // Update enrollment
     // Send notifications
   });
   ```

**Sau callback th√†nh c√¥ng**:
- `payments.status` = 'holding' (ti·ªÅn ƒëang gi·ªØ)
- `payments.signatureVerified` = 1
- T·∫°o `escrow_payments`:
  - `totalAmount` = 2,000,000
  - `releasedAmount` = 0
  - `commissionRate` = 15%
  - `status` = 'holding'
- `class_enrollments.status` = 'active'
- Notification cho c·∫£ h·ªçc sinh v√† gia s∆∞

### 4. Ghi Nh·∫≠n Bu·ªïi H·ªçc

Gia s∆∞ ho√†n th√†nh bu·ªïi h·ªçc:

```
POST /api/sessions/[id]/complete
{
  "tutorNotes": "H·ªçc sinh ti·∫øn b·ªô t·ªët",
  "studentAttended": true
}
```

**T·ª± ƒë·ªông chia ti·ªÅn** (escrow release):

```typescript
// T√≠nh to√°n
amountPerSession = 2,000,000 / 10 = 200,000 VNƒê
platformFee = 200,000 * 15% = 30,000 VNƒê
tutorAmount = 200,000 - 30,000 = 170,000 VNƒê

// ATOMIC TRANSACTION
await db.transaction(async (tx) => {
  // 1. C·∫≠p nh·∫≠t escrow
  escrow.releasedAmount += 200,000
  escrow.platformFee += 30,000

  // 2. C·∫≠p nh·∫≠t wallet gia s∆∞
  tutorWallet.pendingBalance += 170,000
  tutorWallet.totalEarned += 170,000

  // 3. C·∫≠p nh·∫≠t wallet n·ªÅn t·∫£ng
  platformWallet.availableBalance += 30,000
  platformWallet.totalEarned += 30,000

  // 4. Ghi wallet_transactions (2 records)
  // 5. C·∫≠p nh·∫≠t session_records.releasedAmount
  // 6. C·∫≠p nh·∫≠t enrollment.completedSessions
});
```

**K·∫øt qu·∫£**:
- Gia s∆∞: `pendingBalance` +170k (ch·ªù 30 ng√†y)
- N·ªÅn t·∫£ng: `availableBalance` +30k (c√≥ th·ªÉ d√πng ngay)
- Session: `status` = 'completed', `releasedAmount` = 200k
- Enrollment: `completedSessions` = 1/10
- Audit log ghi ƒë·∫ßy ƒë·ªß

### 5. Th·ªëng K√™

**H·ªçc sinh xem**:
```
GET /api/students/[id]/statistics
{
  "totalEnrollments": 3,
  "totalSpent": 5400000,
  "completedSessions": 27,
  "upcomingLessons": 3
}
```

**Gia s∆∞ xem**:
```
GET /api/tutors/[id]/wallet
{
  "pendingBalance": 1700000,   // Ch·ªù duy·ªát
  "availableBalance": 850000,  // C√≥ th·ªÉ r√∫t ngay
  "withdrawnBalance": 3400000, // ƒê√£ r√∫t
  "totalEarned": 5950000,      // T·ªïng t·ª´ tr∆∞·ªõc ƒë·∫øn nay
  "lastPayoutDate": "2025-10-15"
}
```

**Admin xem**:
```
GET /api/admin/statistics
{
  "totalRevenue": 50000000,
  "platformFee": 7500000,     // 15% commission
  "activeEnrollments": 45,
  "pendingPayouts": 15,
  "totalSessions": 320
}
```

### 6. Admin Duy·ªát Thanh To√°n

**Sau 30 ng√†y** (ho·∫∑c khi enrollment ho√†n th√†nh):

```
POST /api/admin/payouts/approve
{
  "tutorId": 5,
  "amount": 1700000
}
```

**Flow**:
```typescript
// Chuy·ªÉn t·ª´ pending ‚Üí available
tutorWallet.pendingBalance -= 1700000
tutorWallet.availableBalance += 1700000

// Ghi wallet_transaction
type: 'payout'
description: 'Chuy·ªÉn t·ª´ pending sang available'

// Audit log
action: 'payout_approved'
performedBy: adminId
```

### 7. R√∫t Ti·ªÅn

Gia s∆∞ t·∫°o y√™u c·∫ßu r√∫t:

```
POST /api/payouts/request
{
  "amount": 500000,
  "bankName": "Vietcombank",
  "bankAccount": "1234567890",
  "bankAccountName": "NGUYEN VAN A"
}
```

**Admin duy·ªát**:
```
POST /api/admin/payouts/[id]/complete
{
  "transactionProof": "https://cdn.../chung-tu.jpg"
}
```

**K·∫øt qu·∫£**:
```typescript
tutorWallet.availableBalance -= 500000
tutorWallet.withdrawnBalance += 500000

payoutRequest.status = 'completed'
payoutRequest.completedAt = NOW()
```

### 8. Ho√†n Ti·ªÅn

Khi l·ªõp b·ªã h·ªßy:

```
POST /api/enrollments/[id]/refund
{
  "reason": "Gia s∆∞ kh√¥ng ph√π h·ª£p"
}
```

**T√≠nh to√°n ho√†n ti·ªÅn**:
```typescript
totalAmount = 2,000,000       // T·ªïng ƒë√£ ƒë√≥ng
releasedAmount = 400,000      // ƒê√£ h·ªçc 2 bu·ªïi
refundAmount = 1,600,000      // Ho√†n l·∫°i ph·∫ßn ch∆∞a h·ªçc

// Update DB
escrow.status = 'refunded'
payment.status = 'refunded'
enrollment.status = 'cancelled'

// Ho√†n ti·ªÅn qua gateway (n·∫øu c·∫ßn)
// Ho·∫∑c gi·ªØ l·∫°i credit ƒë·ªÉ h·ªçc v·ªõi gia s∆∞ kh√°c
```

## üîí B·∫£o M·∫≠t Chi Ti·∫øt

### 1. HMAC Signature Verification

**VNPay (HMAC-SHA512)**:
```typescript
// T·∫°o signature khi g·ªçi API
const signData = `amount=${amount}&orderId=${orderId}&...`;
const signature = crypto
  .createHmac('sha512', SECRET_KEY)
  .update(signData)
  .digest('hex');

// Verify callback
const receivedSignature = params['vnp_SecureHash'];
const calculatedSignature = crypto
  .createHmac('sha512', SECRET_KEY)
  .update(signDataFromCallback)
  .digest('hex');

if (receivedSignature !== calculatedSignature) {
  throw new Error('Invalid signature - Possible attack!');
}
```

**Momo (HMAC-SHA256)**:
```typescript
const rawSignature =
  `accessKey=${accessKey}&amount=${amount}&orderId=${orderId}&...`;
const signature = crypto
  .createHmac('sha256', SECRET_KEY)
  .update(rawSignature)
  .digest('hex');
```

### 2. Audit Logs

**Ghi log m·ªçi h√†nh ƒë·ªông quan tr·ªçng**:
```sql
CREATE TABLE audit_logs (
  id SERIAL PRIMARY KEY,
  user_id INT,           -- NULL = system
  action VARCHAR(50),    -- payment_created, escrow_released, etc.
  entity_type VARCHAR(50),
  entity_id INT,
  changes TEXT,          -- JSON chi ti·∫øt
  ip_address VARCHAR(50),
  user_agent TEXT,
  created_at TIMESTAMP
);
```

**V√≠ d·ª•**:
```json
{
  "userId": 123,
  "action": "escrow_released",
  "entityType": "session",
  "entityId": 456,
  "changes": {
    "sessionNumber": 5,
    "tutorAmount": 170000,
    "platformFee": 30000
  },
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0...",
  "createdAt": "2025-10-19T14:30:00Z"
}
```

### 3. SQL Injection Prevention

‚úÖ **ƒê√öNG** (s·ª≠ d·ª•ng Drizzle ORM):
```typescript
await db.select()
  .from(payments)
  .where(eq(payments.id, paymentId));
```

‚ùå **SAI** (raw SQL):
```typescript
await db.execute(`SELECT * FROM payments WHERE id = ${paymentId}`);
```

### 4. XSS Prevention

‚úÖ **ƒê√öNG** (encode output):
```typescript
const message = escapeHtml(userInput);
await createNotification({ message });
```

### 5. Environment Variables

**KH√îNG BAO GI·ªú commit v√†o Git**:
```bash
# .env (gitignored)
VNPAY_TMN_CODE=YOUR_TMN_CODE
VNPAY_HASH_SECRET=YOUR_SECRET_KEY
MOMO_PARTNER_CODE=YOUR_PARTNER_CODE
MOMO_SECRET_KEY=YOUR_SECRET_KEY
COMMISSION_RATE=15
DATABASE_URL=mysql://...
CRON_SECRET=random_string_for_cron_auth
```

### 6. Rate Limiting

```typescript
// middleware.ts
import { rateLimit } from '@/lib/rate-limit';

export async function middleware(request: NextRequest) {
  const ip = request.headers.get('x-forwarded-for') || 'unknown';

  const { success } = await rateLimit(ip, {
    limit: 10,        // 10 requests
    window: 60000,    // per minute
  });

  if (!success) {
    return NextResponse.json(
      { error: 'Too many requests' },
      { status: 429 }
    );
  }
}
```

### 7. CSRF Protection

Next.js t·ª± ƒë·ªông b·∫£o v·ªá v·ªõi:
- SameSite cookies
- Origin checking
- CORS headers

## üíæ Database Schema

### class_enrollments (ƒëƒÉng k√Ω l·ªõp)
```sql
id, student_id, tutor_id, subject_id, grade_level_id,
total_sessions, completed_sessions, price_per_session,
total_amount, status, start_date, end_date, schedule, notes
```

### payments (thanh to√°n)
```sql
id, enrollment_id, student_id, amount, method, gateway,
status, transaction_code, gateway_transaction_id,
gateway_response, signature, signature_verified,
ip_address, paid_at, created_at
```

### escrow_payments (gi·ªØ ti·ªÅn)
```sql
id, payment_id, enrollment_id, total_amount, released_amount,
platform_fee, commission_rate, status, last_release_date,
completed_at
```

### session_records (bu·ªïi h·ªçc)
```sql
id, enrollment_id, lesson_id, session_number, date, start_time,
end_time, status, tutor_attended, student_attended,
tutor_notes, completed_at, released_amount
```

### wallets (v√≠ ti·ªÅn)
```sql
id, owner_id, owner_type, available_balance, pending_balance,
withdrawn_balance, total_earned, last_payout_date
```

### wallet_transactions (l·ªãch s·ª≠ v√≠)
```sql
id, wallet_id, type, amount, balance_before, balance_after,
related_id, related_type, description, performed_by, created_at
```

### payout_requests (y√™u c·∫ßu r√∫t ti·ªÅn)
```sql
id, tutor_id, wallet_id, amount, bank_name, bank_account,
bank_account_name, status, request_note, admin_note,
reviewed_by, reviewed_at, completed_at, transaction_proof
```

### audit_logs (nh·∫≠t k√Ω h·ªá th·ªëng)
```sql
id, user_id, action, entity_type, entity_id, changes,
ip_address, user_agent, created_at
```

## ‚ö° T·ªëi ∆Øu Hi·ªáu Su·∫•t

### 1. Batch Queries (Tr√°nh N+1)

‚ùå **SAI**:
```typescript
const sessions = await getSessions();
for (const session of sessions) {
  const student = await getStudentById(session.studentId);
  const tutor = await getTutorById(session.tutorId);
}
// 1 + 2N queries!
```

‚úÖ **ƒê√öNG**:
```typescript
const sessions = await getSessions();
const studentIds = [...new Set(sessions.map(s => s.studentId))];
const tutorIds = [...new Set(sessions.map(s => s.tutorId))];

const [students, tutors] = await Promise.all([
  getStudentsByIds(studentIds),    // 1 query
  getTutorsByIds(tutorIds),        // 1 query
]);

// Total: 3 queries instead of 21!
```

### 2. Caching

**Redis (Production)**:
```typescript
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

async function getSubjects() {
  const cached = await redis.get('subjects:all');
  if (cached) return JSON.parse(cached);

  const subjects = await db.select().from(subjects);
  await redis.setex('subjects:all', 3600, JSON.stringify(subjects));

  return subjects;
}
```

**In-memory (Development)**:
```typescript
const cache = new Map();

export async function withCache(key, ttl, fetchFn) {
  const cached = cache.get(key);
  if (cached && Date.now() - cached.timestamp < ttl) {
    return cached.data;
  }

  const data = await fetchFn();
  cache.set(key, { data, timestamp: Date.now() });

  return data;
}
```

### 3. Database Indexing

```sql
-- Indexes cho performance
CREATE INDEX idx_payments_enrollment ON payments(enrollment_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_transaction_code ON payments(transaction_code);
CREATE INDEX idx_sessions_enrollment ON session_records(enrollment_id);
CREATE INDEX idx_wallets_owner ON wallets(owner_id, owner_type);
CREATE INDEX idx_wallet_txns_wallet ON wallet_transactions(wallet_id);
CREATE INDEX idx_audit_logs_entity ON audit_logs(entity_type, entity_id);
```

### 4. Connection Pooling

```typescript
// drizzle config
const pool = mysql.createPool({
  uri: process.env.DATABASE_URL,
  connectionLimit: 15,      // ƒê·ªß cho shared hosting
  waitForConnections: true,
  queueLimit: 0,
  maxIdle: 5,
  idleTimeout: 60000,
  enableKeepAlive: true,
});
```

## üöÄ Deployment Checklist

### Environment Variables
- [ ] `VNPAY_TMN_CODE`
- [ ] `VNPAY_HASH_SECRET`
- [ ] `MOMO_PARTNER_CODE`
- [ ] `MOMO_SECRET_KEY`
- [ ] `COMMISSION_RATE` (default: 15)
- [ ] `DATABASE_URL`
- [ ] `NEXTAUTH_SECRET`
- [ ] `CRON_SECRET`

### Database
- [ ] Run migrations
- [ ] Create indexes
- [ ] Set up backup (daily)
- [ ] Configure read replica (optional)

### Payment Gateways
- [ ] Register VNPay merchant account
- [ ] Register Momo business account
- [ ] Configure callback URLs
- [ ] Test sandbox first
- [ ] Switch to production

### Monitoring
- [ ] Set up error tracking (Sentry)
- [ ] Set up uptime monitoring
- [ ] Create alerts for failed payments
- [ ] Monitor escrow balance daily

### Security
- [ ] Enable HTTPS only
- [ ] Configure CORS properly
- [ ] Set up rate limiting
- [ ] Regular security audits
- [ ] Backup audit logs

## üìö API Documentation

Xem chi ti·∫øt t·∫°i: [API_DOCUMENTATION.md](./API_DOCUMENTATION.md)

## üß™ Testing

```bash
# Test payment creation
curl -X POST http://localhost:3000/api/payment/create \
  -H "Content-Type: application/json" \
  -d '{"enrollmentId": 1, "gateway": "vnpay"}'

# Test session completion
curl -X POST http://localhost:3000/api/sessions/1/complete \
  -H "Content-Type: application/json" \
  -d '{"tutorNotes": "Good session", "studentAttended": true}'
```

## üìû Support

N·∫øu c√≥ v·∫•n ƒë·ªÅ:
1. Check audit logs
2. Check database transaction history
3. Verify signature in callback
4. Contact admin for manual intervention

---

**Generated with Claude Code** ü§ñ
**Date**: 2025-10-19
**Version**: 1.0.0
