import { useState, useEffect, useMemo, useRef } from "react";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox";
import { Input } from "@/components/ui/input"; // ‚úÖ NEW: For full name input
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"; // ‚úÖ NEW: For grade & subject
import { Clock, Calendar as CalendarIcon, CheckCircle2, Package, BookOpen, Sparkles, AlertCircle, Loader2, User } from "lucide-react";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { useSession } from "next-auth/react";
import { useToast } from "@/hooks/use-toast";
import { useRouter } from "next/navigation"; // ‚úÖ NEW: For redirect to login

interface Subject {
  subjectId?: number; // ‚úÖ NEW: Subject ID from JSON
  subjectName?: string; // ‚úÖ NEW: Subject name
  name?: string; // ‚úÖ BACKWARD COMPAT: Old format
  grades?: string[] | string; // ‚úÖ Support both array and string
}

interface AvailableSlot {
  id: string;
  dayLabels: string;
  startTime: string;
  endTime: string;
  price: number;
  sessionsPerWeek: number;
}

interface BookingDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  tutorId: number;
  tutorName: string;
  hourlyRate: number;
  lessonDuration: number;
  availableSlots?: AvailableSlot[];
  tutorSubjects?: Subject[];
  preSelectedSlotId?: string; // ‚úÖ UX: Pre-select slot when user clicks from schedule
  openAsTrialMode?: boolean; // ‚úÖ UX: Auto-check trial mode when opening from trial button
}

const PACKAGES = [
  { id: "1m", months: 1, discount: 0, label: "1 th√°ng", popular: false },
  { id: "2m", months: 2, discount: 3, label: "2 th√°ng (gi·∫£m 3%)", popular: false },
  { id: "3m", months: 3, discount: 5, label: "3 th√°ng (gi·∫£m 5%)", popular: true },
  { id: "6m", months: 6, discount: 8, label: "6 th√°ng (gi·∫£m 8%)", popular: false },
  { id: "12m", months: 12, discount: 12, label: "12 th√°ng (gi·∫£m 12%)", popular: false },
];

export function BookingDialog({ 
  open, 
  onOpenChange, 
  tutorId,
  tutorName, 
  hourlyRate,
  lessonDuration,
  availableSlots = [],
  tutorSubjects = [],
  preSelectedSlotId,
  openAsTrialMode = false
}: BookingDialogProps) {
  const { data: session, status } = useSession();
  const { toast } = useToast();
  const router = useRouter();
  
  // Refs for error scrolling
  const fullNameRef = useRef<HTMLDivElement>(null); // ‚úÖ NEW
  const subjectsRef = useRef<HTMLDivElement>(null);
  const gradeRef = useRef<HTMLDivElement>(null);
  const slotRef = useRef<HTMLDivElement>(null);
  
  // ‚úÖ NEW: Student profile fields
  const [fullName, setFullName] = useState<string>("");
  const [studentGradeLevel, setStudentGradeLevel] = useState<string>(""); // L·ªõp ƒëang h·ªçc c·ªßa h·ªçc sinh
  
  const [selectedSlot, setSelectedSlot] = useState<string>("");
  const [selectedPackage, setSelectedPackage] = useState<string>("1m"); // Default: 1 th√°ng
  const [selectedSubject, setSelectedSubject] = useState<string>(""); // ‚úÖ CHANGED: Single subject selection
  const [selectedGrade, setSelectedGrade] = useState<string>(""); // ‚úÖ Grade for the subject (m√¥n h·ªçc n√†y d·∫°y cho l·ªõp m·∫•y)
  const [notes, setNotes] = useState<string>(""); // ‚úÖ UX: M√¥ t·∫£ th√™m cho gia s∆∞
  const [isTrial, setIsTrial] = useState<boolean>(false);
  const [isSubmitting, setIsSubmitting] = useState<boolean>(false);
  const [showTrialPreview, setShowTrialPreview] = useState<boolean>(false);
  const [trialLessonsCount, setTrialLessonsCount] = useState<number>(0);
  const [isCheckingTrialLimit, setIsCheckingTrialLimit] = useState<boolean>(false);
  const [isLoadingProfile, setIsLoadingProfile] = useState<boolean>(false);

  // ‚úÖ SECURITY: Check authentication and redirect if needed
  useEffect(() => {
    if (open && status === "unauthenticated") {
      // Close dialog and redirect to login
      onOpenChange(false);
      const currentPath = window.location.pathname;
      router.push(`/login?callbackUrl=${encodeURIComponent(currentPath)}`);
      toast({
        variant: "destructive",
        title: "Vui l√≤ng ƒëƒÉng nh·∫≠p",
        description: "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t l·ªãch h·ªçc v·ªõi gia s∆∞",
      });
    }
  }, [open, status, onOpenChange, router, toast]);

  // ‚úÖ NEW: Load student profile when dialog opens
  useEffect(() => {
    const loadStudentProfile = async () => {
      if (!open || !session?.user?.id) return;
      
      setIsLoadingProfile(true);
      try {
        const response = await fetch(`/api/students/profile?userId=${session.user.id}`);
        if (response.ok) {
          const data = await response.json();
          // Pre-fill form v·ªõi d·ªØ li·ªáu ƒë√£ c√≥
          if (data.fullName) setFullName(data.fullName);
          if (data.gradeLevelId) setStudentGradeLevel(data.gradeLevelId.toString());
        }
      } catch (error) {
        console.error('Failed to load student profile:', error);
      } finally {
        setIsLoadingProfile(false);
      }
    };

    loadStudentProfile();
  }, [open, session?.user?.id]);

  // ‚úÖ Check trial lessons count when dialog opens
  useEffect(() => {
    const checkTrialLimit = async () => {
      if (!open || !session?.user?.id) return;
      
      setIsCheckingTrialLimit(true);
      try {
        const response = await fetch(`/api/lessons/trial-count?studentId=${session.user.id}`);
        if (response.ok) {
          const data = await response.json();
          setTrialLessonsCount(data.count || 0);
        }
      } catch (error) {
        console.error('Failed to check trial limit:', error);
      } finally {
        setIsCheckingTrialLimit(false);
      }
    };

    checkTrialLimit();
  }, [open, session?.user?.id]);

  useEffect(() => {
    if (!open) {
      // Reset khi ƒë√≥ng dialog
      setSelectedSlot("");
      setSelectedPackage("1m"); // Default: 1 th√°ng
      setSelectedSubject(""); // ‚úÖ CHANGED: Reset single subject
      setSelectedGrade("");
      setNotes(""); // Reset notes
      setIsTrial(false);
      setIsSubmitting(false);
      setShowTrialPreview(false);
    } else if (open) {
      // ‚úÖ UX: Auto-check trial mode khi m·ªü t·ª´ n√∫t h·ªçc th·ª≠
      if (openAsTrialMode) {
        setIsTrial(true);
        setShowTrialPreview(true);
      }
      
      // ‚úÖ UX: Set pre-selected slot khi m·ªü dialog v·ªõi slot ƒë√£ ch·ªçn t·ª´ schedule
      if (preSelectedSlotId && availableSlots.some(s => s.id === preSelectedSlotId)) {
        setSelectedSlot(preSelectedSlotId);
        
        // Scroll to slot section if pre-selected
        setTimeout(() => {
          slotRef.current?.scrollIntoView({ behavior: "smooth", block: "center" });
        }, 300);
      }
    }
  }, [open, preSelectedSlotId, availableSlots, openAsTrialMode]);

  // ‚úÖ HELPER: Get available grades for selected subject
  const availableGradesForSubject = useMemo(() => {
    if (!selectedSubject) return [];
    const subject = tutorSubjects.find(s => 
      (s.subjectId?.toString() === selectedSubject) || 
      (s.subjectName === selectedSubject) ||
      (s.name === selectedSubject)
    );
    if (!subject) return [];
    
    // Parse grades (could be string or array)
    if (Array.isArray(subject.grades)) {
      return subject.grades;
    } else if (typeof subject.grades === 'string') {
      // Parse "L·ªõp 10, L·ªõp 11" or JSON array string
      try {
        const parsed = JSON.parse(subject.grades);
        return Array.isArray(parsed) ? parsed : [subject.grades];
      } catch {
        return subject.grades.split(',').map(g => g.trim());
      }
    }
    return [];
  }, [selectedSubject, tutorSubjects]);

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(price);
  };

  const slot = availableSlots.find((s) => s.id === selectedSlot);
  const pkg = PACKAGES.find((p) => p.id === selectedPackage);

  // ‚úÖ PERFORMANCE: Memoized calculations to prevent unnecessary re-renders
  const totalSessions = useMemo(() => {
    if (!slot || !pkg) return 0;
    return pkg.months * slot.sessionsPerWeek * 4;
  }, [slot, pkg]);

  const monthlyPrice = useMemo(() => {
    if (!slot) return 0;
    return slot.sessionsPerWeek * 4 * slot.price;
  }, [slot]);

  const totalPrice = useMemo(() => {
    if (!slot || !pkg) return 0;
    const baseTotal = monthlyPrice * pkg.months;
    const discountAmount = (baseTotal * pkg.discount) / 100;
    return baseTotal - discountAmount;
  }, [slot, pkg, monthlyPrice]);

  const handleBooking = async () => {
    // ‚ö†Ô∏è SECURITY: Validate user is logged in
    if (!session?.user?.id) {
      toast({
        variant: "destructive",
        title: "Ch∆∞a ƒëƒÉng nh·∫≠p",
        description: "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t l·ªãch h·ªçc",
      });
      return;
    }

    // ‚úÖ UX: Validate full name
    if (!fullName.trim()) {
      fullNameRef.current?.scrollIntoView({ behavior: "smooth", block: "center" });
      toast({
        variant: "destructive",
        title: "Thi·∫øu th√¥ng tin",
        description: "Vui l√≤ng nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß",
      });
      return;
    }

    // ‚úÖ UX: Validate student grade level
    if (!studentGradeLevel) {
      fullNameRef.current?.scrollIntoView({ behavior: "smooth", block: "center" });
      toast({
        variant: "destructive",
        title: "Thi·∫øu th√¥ng tin",
        description: "Vui l√≤ng ch·ªçn l·ªõp ƒëang h·ªçc",
      });
      return;
    }

    // ‚úÖ UX: Validate v√† scroll ƒë·∫øn field b·ªã l·ªói
    if (tutorSubjects.length > 0 && !isTrial) {
      if (!selectedSubject) {
        subjectsRef.current?.scrollIntoView({ behavior: "smooth", block: "center" });
        toast({
          variant: "destructive",
          title: "Thi·∫øu th√¥ng tin",
          description: "Vui l√≤ng ch·ªçn m√¥n h·ªçc",
        });
        return;
      }
      if (!selectedGrade) {
        gradeRef.current?.scrollIntoView({ behavior: "smooth", block: "center" });
        toast({
          variant: "destructive",
          title: "Thi·∫øu th√¥ng tin",
          description: "Vui l√≤ng ch·ªçn l·ªõp h·ªçc",
        });
        return;
      }
    }

    // ‚úÖ UX: Validate slot selection (required cho c·∫£ trial v√† regular)
    if (!selectedSlot) {
      slotRef.current?.scrollIntoView({ behavior: "smooth", block: "center" });
      toast({
        variant: "destructive",
        title: "Thi·∫øu th√¥ng tin",
        description: "Vui l√≤ng ch·ªçn ca h·ªçc",
      });
      return;
    }

    setIsSubmitting(true);

    try {
      // ‚úÖ PERFORMANCE: Single API call for booking creation
      const response = await fetch('/api/lessons', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          tutorId,
          availabilityId: isTrial ? parseInt(selectedSlot) : parseInt(selectedSlot), // C·∫£ trial v√† regular ƒë·ªÅu c·∫ßn slot
          fullName: fullName.trim(), // ‚úÖ NEW: Student full name
          studentGradeLevel: parseInt(studentGradeLevel), // ‚úÖ NEW: Student's current grade
          subject: selectedSubject, // ‚úÖ CHANGED: Single subject
          subjectGrade: selectedGrade, // ‚úÖ L·ªõp c·ªßa m√¥n h·ªçc (c√≥ th·ªÉ kh√°c v·ªõi l·ªõp ƒëang h·ªçc)
          notes: notes, // ‚úÖ UX: M√¥ t·∫£ th√™m cho gia s∆∞
          isTrial: isTrial ? 1 : 0,
          totalSessions: isTrial ? 1 : totalSessions,
          packageId: selectedPackage,
          packageMonths: pkg?.months || 1, // S·ªë th√°ng ƒëƒÉng k√Ω
          pricePerSession: slot?.price || 0,
          totalAmount: isTrial ? 0 : totalPrice,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'ƒê√£ c√≥ l·ªói x·∫£y ra');
      }

      // Success
      toast({
        title: "ƒê·∫∑t l·ªãch th√†nh c√¥ng! üéâ",
        description: isTrial 
          ? "Y√™u c·∫ßu h·ªçc th·ª≠ ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn gia s∆∞. B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi gia s∆∞ x√°c nh·∫≠n."
          : `Y√™u c·∫ßu ƒëƒÉng k√Ω ${pkg?.label} (${totalSessions} bu·ªïi) ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn gia s∆∞. B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi gia s∆∞ x√°c nh·∫≠n v√† s·ªë ti·ªÅn c·∫ßn thanh to√°n.`,
      });

      onOpenChange(false);
      
      // ‚úÖ UX: Reload page to show updated data
      setTimeout(() => {
        window.location.reload();
      }, 1500);

    } catch (error) {
      console.error('Booking error:', error);
      toast({
        variant: "destructive",
        title: "ƒê·∫∑t l·ªãch th·∫•t b·∫°i",
        description: error instanceof Error ? error.message : "ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.",
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto" data-testid="booking-dialog">
        <DialogHeader>
          <DialogTitle className="text-2xl">
            ƒê·∫∑t l·ªãch h·ªçc v·ªõi {tutorName}
          </DialogTitle>
          <DialogDescription>
            Ch·ªçn ca h·ªçc v√† g√≥i bu·ªïi h·ªçc ph√π h·ª£p. Sau khi gia s∆∞ x√°c nh·∫≠n, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o v·ªÅ s·ªë ti·ªÅn c·∫ßn thanh to√°n.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-6 py-4">
          {/* Checkbox H·ªçc th·ª≠ */}
          <div className="flex items-start space-x-3 p-4 rounded-lg border-2 border-dashed border-primary/30 bg-primary/5">
            <div className="flex items-center justify-center min-h-[44px] min-w-[44px]">
              <Checkbox
                id="is-trial"
                checked={isTrial}
                onCheckedChange={(checked) => {
                  const isChecked = checked as boolean;
                  
                  // ‚úÖ UX: Check trial limit before allowing selection
                  if (isChecked && trialLessonsCount >= 3) {
                    toast({
                      variant: "destructive",
                      title: "ƒê√£ h·∫øt l∆∞·ª£t h·ªçc th·ª≠",
                      description: "B·∫°n ƒë√£ s·ª≠ d·ª•ng h·∫øt 3 bu·ªïi h·ªçc th·ª≠ mi·ªÖn ph√≠. Vui l√≤ng ƒëƒÉng k√Ω g√≥i h·ªçc ch√≠nh th·ª©c.",
                    });
                    return;
                  }
                  
                  setIsTrial(isChecked);
                  if (isChecked) {
                    setShowTrialPreview(true);
                  }
                }}
                disabled={trialLessonsCount >= 3 || isCheckingTrialLimit}
                className="h-5 w-5"
                data-testid="checkbox-trial"
              />
            </div>
            <div className="flex-1">
              <label
                htmlFor="is-trial"
                className={`text-sm font-medium leading-none cursor-pointer flex items-center gap-2 ${
                  trialLessonsCount >= 3 ? 'opacity-50 cursor-not-allowed' : ''
                }`}
              >
                <Sparkles className="h-4 w-4 text-primary" />
                ƒêƒÉng k√Ω h·ªçc th·ª≠ (mi·ªÖn ph√≠)
              </label>
              <p className="text-sm text-muted-foreground mt-1">
                {trialLessonsCount >= 3 ? (
                  <span className="text-destructive font-medium">
                    ‚ö†Ô∏è B·∫°n ƒë√£ s·ª≠ d·ª•ng h·∫øt 3 bu·ªïi h·ªçc th·ª≠ mi·ªÖn ph√≠
                  </span>
                ) : (
                  <>
                    Bu·ªïi h·ªçc th·ª≠ 30-45 ph√∫t ho√†n to√†n mi·ªÖn ph√≠. 
                    <span className="font-medium text-primary ml-1">
                      C√≤n {3 - trialLessonsCount} l∆∞·ª£t
                    </span>
                  </>
                )}
              </p>
            </div>
          </div>

          {/* Th√¥ng b√°o h·ªçc th·ª≠ */}
          {isTrial && (
            <Alert>
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>
                <strong>L∆∞u √Ω h·ªçc th·ª≠:</strong> Sau khi gia s∆∞ x√°c nh·∫≠n, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o v·ªÅ l·ªãch h·ªçc th·ª≠ c·ª• th·ªÉ. Bu·ªïi h·ªçc th·ª≠ s·∫Ω di·ªÖn ra theo ca h·ªçc m√† gia s∆∞ ƒë√£ ƒëƒÉng k√Ω.
              </AlertDescription>
            </Alert>
          )}

          {/* Th√¥ng tin h·ªçc sinh */}
          <div ref={fullNameRef} className="space-y-4 bg-muted/30 p-4 rounded-lg border">
            <div className="flex items-center gap-2 mb-2">
              <User className="h-5 w-5 text-primary" />
              <h3 className="font-semibold">Th√¥ng tin h·ªçc sinh</h3>
            </div>
            
            <div>
              <Label htmlFor="fullName" className="text-sm font-medium mb-2 flex items-center gap-2">
                H·ªç t√™n ƒë·∫ßy ƒë·ªß <span className="text-destructive">*</span>
              </Label>
              <Input
                id="fullName"
                type="text"
                value={fullName}
                onChange={(e) => setFullName(e.target.value)}
                placeholder="Nguy·ªÖn VƒÉn A"
                className="min-h-[44px]"
                disabled={isLoadingProfile}
                aria-label="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß"
                data-testid="input-fullname"
              />
              <p className="text-xs text-muted-foreground mt-1">
                Gia s∆∞ s·∫Ω bi·∫øt t√™n c·ªßa b·∫°n ƒë·ªÉ g·ªçi
              </p>
            </div>

            <div>
              <Label htmlFor="studentGrade" className="text-sm font-medium mb-2 flex items-center gap-2">
                L·ªõp ƒëang h·ªçc <span className="text-destructive">*</span>
              </Label>
              <Select value={studentGradeLevel} onValueChange={setStudentGradeLevel}>
                <SelectTrigger className="min-h-[44px]" disabled={isLoadingProfile}>
                  <SelectValue placeholder="Ch·ªçn l·ªõp ƒëang h·ªçc" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="6">L·ªõp 6</SelectItem>
                  <SelectItem value="7">L·ªõp 7</SelectItem>
                  <SelectItem value="8">L·ªõp 8</SelectItem>
                  <SelectItem value="9">L·ªõp 9</SelectItem>
                  <SelectItem value="10">L·ªõp 10</SelectItem>
                  <SelectItem value="11">L·ªõp 11</SelectItem>
                  <SelectItem value="12">L·ªõp 12</SelectItem>
                  <SelectItem value="other">Kh√°c</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          {/* Ch·ªçn m√¥n h·ªçc v√† l·ªõp */}
          {tutorSubjects.length > 0 && (
            <>
              <div ref={subjectsRef}>
                <Label htmlFor="subject" className="text-base font-semibold mb-3 flex items-center gap-2">
                  <BookOpen className="h-5 w-5" />
                  M√¥n h·ªçc mu·ªën h·ªçc
                  {!isTrial && <span className="text-destructive">*</span>}
                </Label>
                <Select value={selectedSubject} onValueChange={(value) => {
                  setSelectedSubject(value);
                  setSelectedGrade(""); // Reset grade khi ƒë·ªïi subject
                }}>
                  <SelectTrigger className="min-h-[44px]" aria-label="Ch·ªçn m√¥n h·ªçc">
                    <SelectValue placeholder="Ch·ªçn m√¥n h·ªçc" />
                  </SelectTrigger>
                  <SelectContent>
                    {tutorSubjects.map((subject) => {
                      const subjectName = subject.subjectName || subject.name || '';
                      const subjectId = subject.subjectId?.toString() || subjectName;
                      return (
                        <SelectItem key={subjectId} value={subjectId}>
                          {subjectName}
                        </SelectItem>
                      );
                    })}
                  </SelectContent>
                </Select>
                {selectedSubject && (
                  <p className="text-sm text-muted-foreground mt-2">
                    ƒê√£ ch·ªçn: <strong>{tutorSubjects.find(s => 
                      s.subjectId?.toString() === selectedSubject || 
                      s.subjectName === selectedSubject ||
                      s.name === selectedSubject
                    )?.subjectName || tutorSubjects.find(s => 
                      s.subjectId?.toString() === selectedSubject || 
                      s.subjectName === selectedSubject ||
                      s.name === selectedSubject
                    )?.name}</strong>
                  </p>
                )}
              </div>

              <div ref={gradeRef}>
                <Label htmlFor="subjectGrade" className="text-base font-semibold mb-3 flex items-center gap-2">
                  <BookOpen className="h-5 w-5" />
                  L·ªõp h·ªçc (cho m√¥n n√†y)
                  {!isTrial && <span className="text-destructive">*</span>}
                </Label>
                <Select 
                  value={selectedGrade} 
                  onValueChange={setSelectedGrade}
                  disabled={!selectedSubject}
                >
                  <SelectTrigger className="min-h-[44px]" aria-label="Ch·ªçn l·ªõp h·ªçc">
                    <SelectValue placeholder={selectedSubject ? "Ch·ªçn l·ªõp" : "Ch·ªçn m√¥n h·ªçc tr∆∞·ªõc"} />
                  </SelectTrigger>
                  <SelectContent>
                    {availableGradesForSubject.length > 0 ? (
                      availableGradesForSubject.map((grade) => (
                        <SelectItem key={grade} value={grade}>
                          {grade}
                        </SelectItem>
                      ))
                    ) : (
                      <>
                        <SelectItem value="6">L·ªõp 6</SelectItem>
                        <SelectItem value="7">L·ªõp 7</SelectItem>
                        <SelectItem value="8">L·ªõp 8</SelectItem>
                        <SelectItem value="9">L·ªõp 9</SelectItem>
                        <SelectItem value="10">L·ªõp 10</SelectItem>
                        <SelectItem value="11">L·ªõp 11</SelectItem>
                        <SelectItem value="12">L·ªõp 12</SelectItem>
                      </>
                    )}
                  </SelectContent>
                </Select>
                <p className="text-xs text-muted-foreground mt-1">
                  Ch·ªçn l·ªõp m√† b·∫°n mu·ªën h·ªçc m√¥n n√†y (c√≥ th·ªÉ kh√°c v·ªõi l·ªõp ƒëang h·ªçc)
                </p>
              </div>
            </>
          )}

          {/* M√¥ t·∫£ th√™m cho gia s∆∞ - Kh√¥ng b·∫Øt bu·ªôc */}
          <div>
            <Label htmlFor="notes" className="text-base font-semibold mb-3 flex items-center gap-2">
              <BookOpen className="h-5 w-5" />
              M√¥ t·∫£ th√™m cho gia s∆∞
              <span className="text-sm text-muted-foreground font-normal ml-1">(Kh√¥ng b·∫Øt bu·ªôc)</span>
            </Label>
            <textarea
              id="notes"
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="V√≠ d·ª•: Con em c·∫ßn t·∫≠p trung v√†o ph·∫ßn ƒë·∫°i s·ªë, em ƒëang y·∫øu ph·∫ßn h√¨nh h·ªçc..."
              className="w-full px-4 py-3 min-h-[100px] border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
              aria-label="M√¥ t·∫£ th√™m cho gia s∆∞"
              data-testid="textarea-notes"
              maxLength={500}
            />
            <p className="text-xs text-muted-foreground mt-1">
              {notes.length}/500 k√Ω t·ª±
            </p>
          </div>

          {/* Ch·ªçn ca h·ªçc - Thay ƒë·ªïi behavior cho trial mode */}
          <div ref={slotRef}>
            <Label className="text-base font-semibold mb-3 flex items-center gap-2">
              <CalendarIcon className="h-5 w-5" />
              Ch·ªçn ca h·ªçc
              {!isTrial && <span className="text-destructive">*</span>}
            </Label>
            
            {isTrial && (
              <Alert className="mb-3 bg-blue-50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-800">
                <AlertCircle className="h-4 w-4 text-blue-600 dark:text-blue-400" />
                <AlertDescription className="text-blue-800 dark:text-blue-200">
                  <strong>H·ªçc th·ª≠ mi·ªÖn ph√≠:</strong> Ch·ªçn ca h·ªçc b·∫°n mu·ªën th·ª≠. Bu·ªïi h·ªçc th·ª≠ ho√†n to√†n mi·ªÖn ph√≠, kh√¥ng c·∫ßn thanh to√°n.
                </AlertDescription>
              </Alert>
            )}

            <div className="space-y-3">
              {availableSlots.length === 0 ? (
                <Alert>
                  <AlertCircle className="h-4 w-4" />
                  <AlertDescription>
                    Gia s∆∞ ch∆∞a ƒëƒÉng k√Ω ca h·ªçc n√†o. Vui l√≤ng li√™n h·ªá gia s∆∞ ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.
                  </AlertDescription>
                </Alert>
                  </AlertDescription>
                </Alert>
              ) : (
                availableSlots.map((slot) => (
                  <div
                    key={slot.id}
                    onClick={() => setSelectedSlot(slot.id)}
                    className={`w-full text-left p-4 rounded-lg border-2 transition-all cursor-pointer ${
                      selectedSlot === slot.id
                        ? "border-primary bg-primary/5 hover:bg-primary/10"
                        : "border-border hover:border-primary/50 hover:bg-primary/5"
                    }`}
                    role="button"
                    aria-label={`Ca h·ªçc ${slot.dayLabels} t·ª´ ${slot.startTime} ƒë·∫øn ${slot.endTime}`}
                    data-testid={`slot-option-${slot.id}`}
                  >
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <Badge variant="outline">{slot.dayLabels}</Badge>
                          <Badge variant="secondary">
                            {slot.sessionsPerWeek} bu·ªïi/tu·∫ßn
                          </Badge>
                          {isTrial && (
                            <Badge className="bg-green-500 text-white">
                              Mi·ªÖn ph√≠
                            </Badge>
                          )}
                        </div>
                        <div className="flex items-center gap-2 text-sm text-foreground/80">
                          <Clock className="h-4 w-4" />
                          <span>
                            {slot.startTime} - {slot.endTime}
                          </span>
                        </div>
                      </div>
                      {!isTrial && (
                        <div className="text-right">
                          <p className="font-bold text-lg">
                            {formatPrice(slot.price)}
                          </p>
                          <p className="text-sm text-foreground/70">/bu·ªïi</p>
                        </div>
                      )}
                      {selectedSlot === slot.id && (
                        <CheckCircle2 className="h-6 w-6 text-primary flex-shrink-0" />
                      )}
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>

          {/* Ch·ªçn g√≥i thanh to√°n - Ch·ªâ hi·ªán khi KH√îNG ph·∫£i h·ªçc th·ª≠ */}
          {!isTrial && (
            <>
              <div>
                <Label className="text-base font-semibold mb-3 flex items-center gap-2">
                  <Package className="h-5 w-5" />
                  Ch·ªçn g√≥i ƒëƒÉng k√Ω <span className="text-destructive">*</span>
                </Label>
                <p className="text-sm text-foreground/70 mb-3">
                  G√≥i t·ªëi thi·ªÉu 1 th√°ng. H·ªá th·ªëng t·ª± ƒë·ªông t√≠nh s·ªë bu·ªïi d·ª±a tr√™n l·ªãch h·ªçc ƒë√£ ch·ªçn.
                </p>
                <div className="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-5 gap-3">
                  {PACKAGES.map((pkg) => (
                    <button
                      key={pkg.id}
                      onClick={() => setSelectedPackage(pkg.id)}
                      className={`relative p-4 rounded-lg border-2 transition-all min-h-[80px] flex flex-col justify-center ${
                        selectedPackage === pkg.id
                          ? "border-primary bg-primary/5 hover:bg-primary/10"
                          : "border-border hover:border-primary/50 hover:bg-primary/5"
                      }`}
                      aria-label={`Ch·ªçn g√≥i ${pkg.label}`}
                      data-testid={`package-${pkg.id}`}
                    >
                      {pkg.popular && (
                        <Badge className="absolute -top-2 left-1/2 -translate-x-1/2 bg-primary text-primary-foreground text-xs whitespace-nowrap">
                          Ph·ªï bi·∫øn
                        </Badge>
                      )}
                      <div className="text-center">
                        <p className="font-semibold text-sm sm:text-base">{pkg.months} th√°ng</p>
                        {pkg.discount > 0 && (
                          <p className="text-xs sm:text-sm text-green-600 dark:text-green-400 mt-1 font-medium">
                            Gi·∫£m {pkg.discount}%
                          </p>
                        )}
                      </div>
                      {selectedPackage === pkg.id && (
                        <CheckCircle2 className="h-4 w-4 text-primary absolute bottom-2 right-2" />
                      )}
                    </button>
                  ))}
                </div>
              </div>

              {/* T√≥m t·∫Øt ƒë·∫∑t l·ªãch */}
              {selectedSlot && slot && pkg && (
                <div className="rounded-lg border-2 border-primary/20 bg-gradient-to-br from-primary/5 to-primary/10 p-5">
                  <div className="flex items-center gap-2 mb-4">
                    <CheckCircle2 className="h-5 w-5 text-primary" />
                    <h4 className="font-bold text-lg">Chi ti·∫øt ƒëƒÉng k√Ω</h4>
                  </div>
                  
                  {/* Th√¥ng tin c∆° b·∫£n */}
                  <div className="space-y-3 mb-4">
                    <div className="flex justify-between items-start">
                      <span className="text-sm text-foreground/70">Gia s∆∞</span>
                      <span className="font-semibold text-right">{tutorName}</span>
                    </div>
                    
                    {selectedSubjects.length > 0 && (
                      <div className="flex justify-between items-start">
                        <span className="text-sm text-foreground/70">M√¥n h·ªçc</span>
                        <span className="font-semibold text-right">
                          {selectedSubjects.join(", ")} - L·ªõp {selectedGrade}
                        </span>
                      </div>
                    )}
                    
                    <div className="flex justify-between items-start">
                      <span className="text-sm text-foreground/70">L·ªãch h·ªçc</span>
                      <span className="font-semibold text-right">{slot.dayLabels}</span>
                    </div>
                    
                    <div className="flex justify-between items-start">
                      <span className="text-sm text-foreground/70">Gi·ªù h·ªçc</span>
                      <span className="font-semibold text-right">
                        {slot.startTime} - {slot.endTime}
                      </span>
                    </div>
                    
                    <div className="flex justify-between items-start">
                      <span className="text-sm text-foreground/70">G√≥i</span>
                      <span className="font-semibold text-right">{pkg.label}</span>
                    </div>
                  </div>

                  {/* B·∫£ng t√≠nh ph√≠ */}
                  <div className="border-t border-primary/20 pt-4 space-y-2">
                    <div className="flex justify-between text-sm">
                      <span className="text-foreground/70">
                        {totalSessions} bu·ªïi √ó {formatPrice(slot.price)}
                      </span>
                      <span className="font-medium">
                        {formatPrice(monthlyPrice * pkg.months)}
                      </span>
                    </div>
                    
                    {pkg.discount > 0 && (
                      <div className="flex justify-between text-sm">
                        <span className="text-green-600 dark:text-green-400">
                          Gi·∫£m gi√° {pkg.discount}%
                        </span>
                        <span className="text-green-600 dark:text-green-400 font-medium">
                          -{formatPrice((monthlyPrice * pkg.months * pkg.discount) / 100)}
                        </span>
                      </div>
                    )}
                    
                    <div className="border-t border-primary/20 pt-3 mt-3 flex justify-between items-center">
                      <span className="font-bold text-lg">T·ªïng thanh to√°n</span>
                      <span className="font-bold text-2xl text-primary">
                        {formatPrice(totalPrice)}
                      </span>
                    </div>
                  </div>

                  {/* L∆∞u √Ω */}
                  <Alert className="mt-4 bg-background/50">
                    <AlertCircle className="h-4 w-4" />
                    <AlertDescription className="text-xs">
                      Sau khi gia s∆∞ x√°c nh·∫≠n, b·∫°n s·∫Ω nh·∫≠n th√¥ng b√°o v·ªÅ ng√†y b·∫Øt ƒë·∫ßu h·ªçc v√† h∆∞·ªõng d·∫´n thanh to√°n.
                    </AlertDescription>
                  </Alert>
                </div>
              )}
            </>
          )}
        </div>

        <div className="flex flex-col sm:flex-row gap-3">
          <Button 
            variant="outline" 
            className="flex-1 min-h-[44px]" 
            onClick={() => onOpenChange(false)}
            disabled={isSubmitting}
            aria-label="H·ªßy ƒë·∫∑t l·ªãch"
            data-testid="button-cancel-booking"
          >
            H·ªßy
          </Button>
          <Button 
            className="flex-1 min-h-[44px]" 
            onClick={handleBooking}
            disabled={isSubmitting || !selectedSlot}
            aria-label={isTrial ? "X√°c nh·∫≠n ƒëƒÉng k√Ω h·ªçc th·ª≠" : "X√°c nh·∫≠n ƒëƒÉng k√Ω h·ªçc"}
            data-testid="button-confirm-booking"
          >
            {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            {isSubmitting ? "ƒêang x·ª≠ l√Ω..." : (isTrial ? "ƒêƒÉng k√Ω h·ªçc th·ª≠" : "ƒêƒÉng k√Ω h·ªçc")}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
