<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Whiteboard Viewport Sync</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-teacher {
            background: #2d4a2e;
            border-left: 3px solid #4CAF50;
        }
        .log-student {
            background: #2e3a4a;
            border-left: 3px solid #2196F3;
        }
        .log-error {
            background: #4a2d2d;
            border-left: 3px solid #f44336;
        }
        .log-warn {
            background: #4a3f2d;
            border-left: 3px solid #ff9800;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        .status.success {
            background: #4CAF50;
            color: white;
        }
        .status.fail {
            background: #f44336;
            color: white;
        }
        .status.pending {
            background: #ff9800;
            color: white;
        }
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 8px 0;
        }
        .results {
            margin-top: 20px;
        }
        .result-item {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .result-item.pass {
            background: #c8e6c9;
            border-left: 4px solid #4CAF50;
        }
        .result-item.fail {
            background: #ffcdd2;
            border-left: 4px solid #f44336;
        }
        .result-item.unknown {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Whiteboard Viewport Sync - Auto Test</h1>

        <div class="instructions">
            <h3>üìã H∆∞·ªõng d·∫´n test:</h3>
            <ol>
                <li><strong>M·ªü 2 tabs:</strong>
                    <ul>
                        <li>Tab 1 (Teacher): <code>localhost:3000/test-videolify-v2?room=test&testUserId=1&name=Teacher&role=tutor</code></li>
                        <li>Tab 2 (Student): <code>localhost:3000/test-videolify-v2?room=test&testUserId=2&name=Student&role=student</code></li>
                    </ul>
                </li>
                <li><strong>M·ªü whiteboard</strong> ·ªü c·∫£ 2 tabs</li>
                <li><strong>Nh·∫•n n√∫t "Start Capture Logs"</strong> b√™n d∆∞·ªõi</li>
                <li><strong>·ªû tab Teacher:</strong> Zoom in/out ho·∫∑c v·∫Ω g√¨ ƒë√≥</li>
                <li><strong>ƒê·ª£i 5 gi√¢y</strong> ƒë·ªÉ logs ƒë∆∞·ª£c capture</li>
                <li><strong>Nh·∫•n "Stop & Analyze"</strong> ƒë·ªÉ xem k·∫øt qu·∫£</li>
            </ol>
        </div>

        <div class="test-section">
            <h2>üéÆ Test Controls</h2>
            <button id="startCapture" onclick="startCapture()">‚ñ∂Ô∏è Start Capture Logs</button>
            <button id="stopCapture" onclick="stopAndAnalyze()" disabled>‚èπÔ∏è Stop & Analyze</button>
            <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            <button onclick="window.location.reload()">üîÑ Reset Test</button>

            <div id="status" style="margin-top: 10px;">
                <span class="status pending">‚è≥ Ch∆∞a b·∫Øt ƒë·∫ßu</span>
            </div>
        </div>

        <div class="test-section">
            <h2>üìä Captured Logs</h2>
            <div id="logContainer" class="log-container">
                <div style="color: #888; text-align: center; padding: 20px;">
                    Nh·∫•n "Start Capture Logs" ƒë·ªÉ b·∫Øt ƒë·∫ßu...
                </div>
            </div>
        </div>

        <div class="test-section results">
            <h2>‚úÖ Test Results</h2>
            <div id="resultsContainer">
                <div style="color: #888; text-align: center; padding: 20px;">
                    K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã sau khi analyze...
                </div>
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        let captureInterval = null;
        let startTime = 0;

        function startCapture() {
            logs = [];
            startTime = Date.now();

            document.getElementById('startCapture').disabled = true;
            document.getElementById('stopCapture').disabled = false;
            document.getElementById('status').innerHTML = '<span class="status pending">üì° ƒêang capture logs...</span>';

            // Capture logs every 500ms
            captureInterval = setInterval(() => {
                captureLogs();
                displayLogs();
            }, 500);

            // Auto stop after 30 seconds
            setTimeout(() => {
                if (captureInterval) {
                    stopAndAnalyze();
                }
            }, 30000);
        }

        function captureLogs() {
            // Get console logs from window (if available)
            if (window.__excalidrawLogs) {
                window.__excalidrawLogs.forEach(log => {
                    if (!logs.find(l => l.text === log && l.time === log.time)) {
                        logs.push({
                            time: Date.now() - startTime,
                            text: log,
                            type: detectLogType(log)
                        });
                    }
                });
            }
        }

        function detectLogType(text) {
            if (text.includes('[ExcalidrawSync]')) {
                if (text.includes('Teacher')) return 'teacher';
                if (text.includes('Student')) return 'student';
                if (text.includes('ERROR') || text.includes('‚ùå')) return 'error';
                if (text.includes('WARN') || text.includes('‚ö†Ô∏è')) return 'warn';
                return 'info';
            }
            return 'other';
        }

        function displayLogs() {
            const container = document.getElementById('logContainer');
            if (logs.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Ch∆∞a c√≥ logs...</div>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const className = log.type === 'teacher' ? 'log-teacher' :
                                 log.type === 'student' ? 'log-student' :
                                 log.type === 'error' ? 'log-error' :
                                 log.type === 'warn' ? 'log-warn' : '';
                return `<div class="log-entry ${className}">
                    <strong>[${(log.time / 1000).toFixed(2)}s]</strong> ${escapeHtml(log.text)}
                </div>`;
            }).join('');

            // Auto scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function stopAndAnalyze() {
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }

            document.getElementById('startCapture').disabled = false;
            document.getElementById('stopCapture').disabled = true;
            document.getElementById('status').innerHTML = '<span class="status success">‚úÖ ƒê√£ d·ª´ng - Analyzing...</span>';

            analyzeLogs();
        }

        function analyzeLogs() {
            const results = {
                teacherSyncingViewport: false,
                studentReceivingViewport: false,
                viewportDataPresent: false,
                dataChannelOpen: false,
                errors: []
            };

            logs.forEach(log => {
                const text = log.text;

                if (text.includes('Teacher syncing viewport')) {
                    results.teacherSyncingViewport = true;
                    // Check if viewport data is present
                    if (text.includes('zoom:') && !text.includes('undefined')) {
                        results.viewportDataPresent = true;
                    }
                }

                if (text.includes('Received appState with viewport')) {
                    results.studentReceivingViewport = true;
                }

                if (text.includes('Data channel OPEN')) {
                    results.dataChannelOpen = true;
                }

                if (text.includes('ERROR') || text.includes('‚ùå')) {
                    results.errors.push(text);
                }
            });

            displayResults(results);
        }

        function displayResults(results) {
            const container = document.getElementById('resultsContainer');

            let html = '';

            // Test 1: Teacher syncing viewport
            html += createResultItem(
                'Teacher g·ª≠i viewport data',
                results.teacherSyncingViewport,
                results.teacherSyncingViewport
                    ? 'Teacher ƒëang sync viewport ‚úÖ'
                    : 'Kh√¥ng th·∫•y teacher sync viewport - Ki·ªÉm tra teacher c√≥ zoom/pan kh√¥ng'
            );

            // Test 2: Viewport data present
            html += createResultItem(
                'Viewport data c√≥ gi√° tr·ªã (kh√¥ng undefined)',
                results.viewportDataPresent,
                results.viewportDataPresent
                    ? 'Viewport data h·ª£p l·ªá ‚úÖ'
                    : 'Viewport data l√† undefined - Excalidraw ch∆∞a c√≥ zoom data'
            );

            // Test 3: Student receiving viewport
            html += createResultItem(
                'Student nh·∫≠n viewport updates',
                results.studentReceivingViewport,
                results.studentReceivingViewport
                    ? 'Student ƒëang nh·∫≠n viewport ‚úÖ'
                    : 'Student KH√îNG nh·∫≠n viewport - L·ªói DataChannel ho·∫∑c onChange'
            );

            // Test 4: DataChannel open
            html += createResultItem(
                'DataChannel ƒëang m·ªü',
                results.dataChannelOpen,
                results.dataChannelOpen
                    ? 'DataChannel ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng ‚úÖ'
                    : 'DataChannel ch∆∞a m·ªü - L·ªói k·∫øt n·ªëi P2P'
            );

            // Errors
            if (results.errors.length > 0) {
                html += `<div class="result-item fail">
                    <div>
                        <strong>‚ùå C√≥ ${results.errors.length} l·ªói:</strong><br>
                        ${results.errors.slice(0, 3).map(e => `‚Ä¢ ${escapeHtml(e.substring(0, 100))}`).join('<br>')}
                    </div>
                </div>`;
            }

            // Overall status
            const allPassed = results.teacherSyncingViewport &&
                            results.viewportDataPresent &&
                            results.studentReceivingViewport &&
                            results.dataChannelOpen;

            if (allPassed) {
                document.getElementById('status').innerHTML = '<span class="status success">‚úÖ T·∫§T C·∫¢ TEST ƒê·ªÄU PASS!</span>';
            } else {
                document.getElementById('status').innerHTML = '<span class="status fail">‚ùå C√ì L·ªñI - Xem chi ti·∫øt b√™n d∆∞·ªõi</span>';
            }

            container.innerHTML = html;
        }

        function createResultItem(title, passed, message) {
            const className = passed === true ? 'pass' : passed === false ? 'fail' : 'unknown';
            const icon = passed === true ? '‚úÖ' : passed === false ? '‚ùå' : '‚ö†Ô∏è';

            return `<div class="result-item ${className}">
                <div>
                    <strong>${icon} ${title}</strong><br>
                    <small>${message}</small>
                </div>
            </div>`;
        }

        function clearLogs() {
            logs = [];
            displayLogs();
            document.getElementById('resultsContainer').innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã sau khi analyze...</div>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Instructions for capturing logs from browser console
        console.log('%cüìã H∆Ø·ªöNG D·∫™N CAPTURE LOGS:', 'font-size: 16px; font-weight: bold; color: #2196F3;');
        console.log('%cƒê·ªÉ test t·ª± ƒë·ªông ho·∫°t ƒë·ªông, c·∫ßn th√™m code n√†y v√†o useExcalidrawSync.ts:', 'color: #666;');
        console.log('%c\n// Add this at the top of useExcalidrawSync.ts:\nif (typeof window !== "undefined") {\n  window.__excalidrawLogs = window.__excalidrawLogs || [];\n}\n\n// Then wrap all console.log with:\nconsole.log(...);\nif (typeof window !== "undefined") {\n  window.__excalidrawLogs.push(...);\n}', 'background: #f5f5f5; padding: 10px; font-family: monospace;');

        console.log('%c\n‚ö†Ô∏è HO·∫∂C ƒë∆°n gi·∫£n h∆°n:', 'color: #ff9800; font-weight: bold;');
        console.log('%cM·ªü DevTools Console ·ªü tab Teacher v√† Student, sau ƒë√≥ copy to√†n b·ªô logs paste v√†o ƒë√¢y ƒë·ªÉ t√¥i analyze!', 'color: #666;');
    </script>
</body>
</html>
